---
- file: path={{mysql_data_path}} state=directory mode=0770 owner={{process_uid}} recurse=true
- file: path={{mysql_conf_path}} state=directory mode=0777 owner={{process_uid}} recurse=true

- name: Create MySQL group
  group:
    name: "{{mysql_group}}"
    state: present
    gid: "{{process_gid}}"

- name: Create MySQL user
  user:
    name: "{{ mysql_user }}"
    uid: "{{process_uid}}"
    group: "{{mysql_group}}"
    state: present

- name: mysql in docker
  docker_container:
    name: "{{mysql_hostname}}"
    hostname: "{{mysql_hostname}}"
    image: mysql
    state: started
    restart_policy: always
    pull: true
    purge_networks: yes
    networks:
      - name: "{{network_name}}"
        ipv4_address: "{{ipaddr}}"
    ports:
      - 3306:3306
    log_driver: syslog
    log_opt:
      tag: "mysql"
    env:
      PUID: "{{process_uid}}"
      PGID: "{{process_gid}}"
      MYSQL_ROOT_PASSWORD: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        32633230306233386238376666656161663332646661636661313765643330643733353536633963
        3862306666373531313365363031383361326431333265320a383164393731623434613430313065
        32376534653866333935636266613439333436653230343064643534646135653333306539396561
        3564346635343332350a313238653934393337376439346664653061373431353739663564636232
        63396464363835376438373764393435353563623562316361623633633830386136343039356430
        3563336363343535663834396631383238356134663366333538
      TZ: "Europe/Madrid"
    volumes:
      - "{{mysql_data_path}}:/var/lib/mysql"
      - "{{mysql_conf_path}}:/etc/mysql/conf.d"

